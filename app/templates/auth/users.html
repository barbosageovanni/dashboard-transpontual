{% extends "base_sidebar.html" %}

{% block title %}
    {% if usuario and usuario.id %}Editar Usu√°rio{% else %}Novo Usu√°rio{% endif %} - Dashboard Baker SSO
{% endblock %}

{% block extra_css %}
<style>
/* Header SSO Padronizado */
.admin-header {
    background: linear-gradient(135deg, #4CAF50 0%, #3ecf8e 100%);
    color: white;
    padding: 2rem;
    margin-bottom: 2rem;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.sso-badge {
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 0.5rem;
}

.btn-admin {
    background: linear-gradient(45deg, #4CAF50, #3ecf8e);
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
}

.btn-admin:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
    color: white;
    text-decoration: none;
}

/* Formul√°rio Padronizado */
.form-section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 2rem;
    margin-bottom: 2rem;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #eee;
}

.section-header h3 {
    margin: 0;
    color: #333;
    font-weight: 600;
}

/* Perfis SSO Unificados */
.role-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: capitalize;
}

.role-admin { background: #dc3545; color: white; }
.role-gestor { background: #ffc107; color: #212529; }
.role-fiscal { background: #17a2b8; color: white; }
.role-financeiro { background: #28a745; color: white; }
.role-operacional { background: #007bff; color: white; }
.role-estagiario { background: #6c757d; color: white; }

/* Sistema Tags */
.system-tag {
    padding: 0.125rem 0.375rem;
    border-radius: 3px;
    font-size: 0.7rem;
    font-weight: 500;
    color: white;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.system-frotas { background: #FF6B35; }
.system-baker { background: #4CAF50; }
.system-financeiro { background: #2196F3; }

.fade-in {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Alertas SSO */
.sso-info {
    background: linear-gradient(45deg, #17a2b8, #20c997);
    color: white;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header SSO Unificado -->
    <div class="admin-header fade-in">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="fas fa-user-plus"></i>
                    {% if usuario and usuario.id %}Editar Usu√°rio{% else %}Novo Usu√°rio{% endif %}
                </h1>
                <p>Dashboard Baker - SSO Integrado
                    <span class="sso-badge">SSO Ativo</span>
                </p>
            </div>
            <div>
                <a href="{{ url_for('admin.users') }}" class="btn-admin">
                    <i class="fas fa-arrow-left"></i> Voltar √† Lista
                </a>
                <div class="btn-group ms-2" role="group">
                    <button type="button" class="btn btn-outline-light dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-exchange-alt"></i> Sistemas
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="https://transpontual-sistema-frotas.onrender.com/users" target="_blank">
                            <i class="fas fa-truck"></i> Sistema de Frotas
                        </a></li>
                        <li><a class="dropdown-item" href="https://transpontual-financial-system.onrender.com/users" target="_blank">
                            <i class="fas fa-calculator"></i> Sistema Financeiro
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerta SSO -->
    <div class="sso-info">
        <i class="fas fa-info-circle"></i>
        <strong>Integra√ß√£o SSO:</strong> Este usu√°rio ter√° acesso unificado a todos os sistemas Transpontual.
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Formul√°rio Principal -->
            <div class="form-section">
                <div class="section-header">
                    <h3>
                        <i class="fas fa-user-cog"></i> Dados do Usu√°rio
                        <span class="system-tag system-baker">Baker</span>
                    </h3>
                </div>

                <form method="POST" id="usuario-form">
                    <!-- Dados B√°sicos -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="nome" class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="nome" name="nome"
                                   value="{{ (usuario.nome if usuario else '') or '' }}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="email" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="email" name="email"
                                   value="{{ (usuario.email if usuario else '') or '' }}" required>
                            <div class="form-text">
                                <i class="fas fa-shield-alt text-success"></i>
                                Este email ser√° usado para SSO entre sistemas
                            </div>
                        </div>
                    </div>

                    <!-- Perfil Unificado SSO -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="papel" class="form-label">Perfil de Acesso *</label>
                            <select class="form-select" id="papel" name="papel" required>
                                <option value="">Selecione o perfil</option>
                                <option value="admin" {{ 'selected' if usuario and usuario.papel == 'admin' }}>üîß Administrador Global</option>
                                <option value="gestor" {{ 'selected' if usuario and usuario.papel == 'gestor' }}>üëî Gestor de Opera√ß√µes</option>
                                <option value="fiscal" {{ 'selected' if usuario and usuario.papel == 'fiscal' }}>üìã Respons√°vel Fiscal</option>
                                <option value="financeiro" {{ 'selected' if usuario and usuario.papel == 'financeiro' }}>üí∞ Analista Financeiro</option>
                                <option value="operacional" {{ 'selected' if usuario and usuario.papel == 'operacional' }}>üöõ Operador de Frota</option>
                                <option value="estagiario" {{ 'selected' if usuario and usuario.papel == 'estagiario' }}>üéì Estagi√°rio</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="ativo" class="form-label">Status</label>
                            <select class="form-select" id="ativo" name="ativo">
                                <option value="true" {{ 'selected' if not usuario or usuario.ativo != False }}>‚úÖ Ativo</option>
                                <option value="false" {{ 'selected' if usuario and usuario.ativo == False }}>‚ùå Inativo</option>
                            </select>
                        </div>
                    </div>

                    {% if not usuario or not usuario.id %}
                    <!-- Senha apenas para novos usu√°rios -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="password" class="form-label">Senha *</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="col-md-6">
                            <label for="confirm_password" class="form-label">Confirmar Senha *</label>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                        </div>
                    </div>
                    {% endif %}

                    <!-- A√ß√µes -->
                    <div class="row">
                        <div class="col-12">
                            <button type="submit" class="btn-admin">
                                <i class="fas fa-save"></i>
                                {% if usuario and usuario.id %}Atualizar Usu√°rio{% else %}Criar Usu√°rio{% endif %}
                            </button>
                            <a href="{{ url_for('admin.users') }}" class="btn btn-secondary ms-2">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Informa√ß√µes SSO -->
            <div class="form-section">
                <div class="section-header">
                    <h3>
                        <i class="fas fa-link"></i> Integra√ß√£o SSO
                    </h3>
                </div>

                <div class="mb-3">
                    <h6><i class="fas fa-systems text-info"></i> Sistemas Integrados</h6>
                    <div class="d-flex flex-wrap gap-1 mb-3">
                        <span class="system-tag system-frotas">Frotas</span>
                        <span class="system-tag system-baker">Baker</span>
                        <span class="system-tag system-financeiro">Financeiro</span>
                    </div>
                </div>

                <div class="mb-3">
                    <h6><i class="fas fa-shield-alt text-success"></i> Seguran√ßa</h6>
                    <ul class="list-unstyled small">
                        <li>‚úÖ Autentica√ß√£o centralizada</li>
                        <li>‚úÖ Sess√£o unificada</li>
                        <li>‚úÖ Permiss√µes sincronizadas</li>
                    </ul>
                </div>

                {% if usuario and usuario.id %}
                <div class="mb-3">
                    <h6><i class="fas fa-clock text-warning"></i> √öltimo Acesso</h6>
                    <p class="small">
                        {% if usuario.ultimo_acesso %}
                            {{ usuario.ultimo_acesso|datetime }}
                        {% else %}
                            Nunca acessou
                        {% endif %}
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    console.log('üìä Dashboard Baker - Formul√°rio de Usu√°rio SSO carregado');

    // Valida√ß√£o de senha em tempo real
    $('#confirm_password').on('blur', function() {
        const password = $('#password').val();
        const confirmPassword = $(this).val();

        if (password && confirmPassword && password !== confirmPassword) {
            $(this).addClass('is-invalid');
            if (!$(this).siblings('.invalid-feedback').length) {
                $(this).after('<div class="invalid-feedback">As senhas n√£o coincidem</div>');
            }
        } else {
            $(this).removeClass('is-invalid');
            $(this).siblings('.invalid-feedback').remove();
        }
    });

    // Valida√ß√£o do formul√°rio
    $('#usuario-form').on('submit', function(e) {
        e.preventDefault();

        const password = $('#password').val();
        const confirmPassword = $('#confirm_password').val();

        if (password && confirmPassword && password !== confirmPassword) {
            showError('As senhas n√£o coincidem');
            return false;
        }

        if (password && password.length < 6) {
            showError('A senha deve ter pelo menos 6 caracteres');
            return false;
        }

        // Se valida√ß√µes passaram, submeter o formul√°rio
        this.submit();
    });
});

// Fun√ß√µes de notifica√ß√£o
function showError(message) {
    // Implementar notifica√ß√£o de erro
    alert('Erro: ' + message);
}

function showSuccess(message) {
    // Implementar notifica√ß√£o de sucesso
    alert('Sucesso: ' + message);
}

// Fun√ß√£o para mostrar/ocultar se√ß√µes baseado no perfil
function updatePermissionsByRole() {
    const papel = $('#papel').val();
    const systemTags = $('.system-tag');

    // Destacar sistemas baseado no perfil
    systemTags.removeClass('active');

    switch(papel) {
        case 'admin':
            systemTags.addClass('active');
            break;
        case 'financeiro':
            $('.system-financeiro, .system-baker').addClass('active');
            break;
        case 'operacional':
            $('.system-frotas, .system-baker').addClass('active');
            break;
        default:
            $('.system-baker').addClass('active');
    }
}

// Aplicar mudan√ßas quando o papel for alterado
$('#papel').on('change', updatePermissionsByRole);
</script>
{% endblock %}