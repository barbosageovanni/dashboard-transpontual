{% extends "base_sidebar.html" %}

{% block title %}Alertas - Dashboard Transpontual{% endblock %}

{% block extra_css %}
<style>
    .alert-card {
        border-left: 4px solid;
        transition: transform 0.2s ease;
    }

    .alert-card:hover {
        transform: translateY(-2px);
    }

    .alert-critico {
        border-left-color: #dc3545;
        background-color: rgba(220, 53, 69, 0.05);
    }

    .alert-alto {
        border-left-color: #fd7e14;
        background-color: rgba(253, 126, 20, 0.05);
    }

    .alert-medio {
        border-left-color: #ffc107;
        background-color: rgba(255, 193, 7, 0.05);
    }

    .alert-baixo {
        border-left-color: #28a745;
        background-color: rgba(40, 167, 69, 0.05);
    }

    .status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-bell me-2"></i>Sistema de Alertas
                    </h1>
                    <p class="text-muted mb-0">Monitoramento e gest√£o de alertas do sistema</p>
                </div>
                <div>
                    <button class="btn btn-outline-primary" onclick="atualizarAlertas()">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        Atualizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de Resumo -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <div class="h2 text-danger mb-1" id="totalAlertas">-</div>
                    <div class="text-muted small">Total de Alertas</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <div class="h2 text-warning mb-1" id="alertasCriticos">-</div>
                    <div class="text-muted small">Cr√≠ticos</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <div class="h2 text-primary mb-1" id="valorRisco">R$ -</div>
                    <div class="text-muted small">Valor em Risco</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <span class="badge bg-success status-badge" id="statusSistema">Normal</span>
                    <div class="text-muted small mt-1">Status do Sistema</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Alertas -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-list me-2"></i>Alertas Ativos
                    </h5>
                </div>
                <div class="card-body">
                    <div id="alertasContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-2 text-muted">Carregando alertas...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    carregarAlertas();

    // Auto-refresh a cada 2 minutos
    setInterval(carregarAlertas, 120000);
});

function carregarAlertas() {
    console.log('üîî Carregando alertas...');

    // Carregar resumo
    $.get('/alertas/api/alertas/resumo')
        .done(function(data) {
            if (data.success) {
                const resumo = data.resumo;
                $('#totalAlertas').text(resumo.total_alertas);
                $('#alertasCriticos').text(resumo.alertas_criticos);
                $('#valorRisco').text('R$ ' + (resumo.valor_total_risco || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2}));

                // Status do sistema
                const statusBadge = $('#statusSistema');
                statusBadge.removeClass('bg-success bg-warning bg-danger');

                if (resumo.status_sistema === 'critico') {
                    statusBadge.addClass('bg-danger').text('Cr√≠tico');
                } else if (resumo.alertas_criticos > 0) {
                    statusBadge.addClass('bg-warning').text('Aten√ß√£o');
                } else {
                    statusBadge.addClass('bg-success').text('Normal');
                }
            }
        })
        .fail(function() {
            console.error('‚ùå Erro ao carregar resumo de alertas');
        });

    // Carregar lista detalhada
    $.get('/alertas/api/alertas-ativos')
        .done(function(data) {
            if (data.success) {
                renderizarAlertas(data.alertas);
            } else {
                mostrarErroAlertas('Erro ao carregar alertas: ' + (data.error || 'Erro desconhecido'));
            }
        })
        .fail(function(xhr) {
            mostrarErroAlertas('Falha na comunica√ß√£o com o servidor');
        });
}

function renderizarAlertas(alertas) {
    const container = $('#alertasContainer');

    if (!alertas || alertas.length === 0) {
        container.html(`
            <div class="text-center py-4">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                <h5 class="mt-3">Nenhum alerta ativo</h5>
                <p class="text-muted">Todos os sistemas est√£o funcionando normalmente.</p>
            </div>
        `);
        return;
    }

    let html = '';
    alertas.forEach(alerta => {
        const tipoClass = getTipoClass(alerta.tipo);
        const icone = getTipoIcon(alerta.tipo);

        html += `
            <div class="alert-card card mb-3 ${tipoClass}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="mb-1">
                                <i class="${icone} me-2"></i>
                                ${alerta.titulo || 'Alerta'}
                            </h6>
                            <p class="mb-2 text-muted">${alerta.descricao || 'Sem descri√ß√£o'}</p>
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>
                                ${alerta.data_criacao || 'Agora'}
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            ${alerta.valor ? `<div class="h5 mb-1">R$ ${alerta.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>` : ''}
                            <span class="badge ${getBadgeClass(alerta.tipo)}">${alerta.tipo?.toUpperCase() || 'NORMAL'}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    container.html(html);
}

function getTipoClass(tipo) {
    const classes = {
        'critico': 'alert-critico',
        'alto': 'alert-alto',
        'medio': 'alert-medio',
        'baixo': 'alert-baixo'
    };
    return classes[tipo] || 'alert-baixo';
}

function getTipoIcon(tipo) {
    const icons = {
        'critico': 'bi bi-exclamation-triangle-fill text-danger',
        'alto': 'bi bi-exclamation-circle-fill text-warning',
        'medio': 'bi bi-info-circle-fill text-info',
        'baixo': 'bi bi-check-circle-fill text-success'
    };
    return icons[tipo] || 'bi bi-info-circle';
}

function getBadgeClass(tipo) {
    const classes = {
        'critico': 'bg-danger',
        'alto': 'bg-warning',
        'medio': 'bg-info',
        'baixo': 'bg-success'
    };
    return classes[tipo] || 'bg-secondary';
}

function mostrarErroAlertas(mensagem) {
    $('#alertasContainer').html(`
        <div class="text-center py-4">
            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
            <h5 class="mt-3">Erro ao carregar alertas</h5>
            <p class="text-muted">${mensagem}</p>
            <button class="btn btn-outline-primary" onclick="carregarAlertas()">
                <i class="bi bi-arrow-clockwise me-1"></i>
                Tentar Novamente
            </button>
        </div>
    `);
}

function atualizarAlertas() {
    carregarAlertas();
    showToast('Alertas atualizados!', 'success');
}
</script>
{% endblock %}