{% extends "base_sidebar.html" %}

{% block title %}Dashboard Transpontual{% endblock %}

{% block extra_css %}
<!-- CSS espec√≠fico do Dashboard -->
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Principal -->
    <div class="header-card">
        <h1>Sistema de Gest√£o Financeira</h1>
        <small id="ultimaAtualizacao">Carregando...</small>
    </div>

    <!-- Cards de M√©tricas Principais -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="metric-card">
                <div class="metric-number" id="valorTotal">R$ 0,00</div>
                <div class="metric-title">üí∞ Receita Total</div>
                <div class="metric-subtitle" id="crescimentoMensal">üìà 0% vs m√™s anterior</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="metric-card">
                <div class="metric-number" id="totalCtes">0</div>
                <div class="metric-title">üìã CTEs Total</div>
                <div class="metric-subtitle" id="ticketMedio">üíµ Ticket m√©dio: R$ 0,00</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="metric-card">
                <div class="metric-number" id="processosCompletos">0</div>
                <div class="metric-title">‚úÖ Processos Completos</div>
                <div class="metric-subtitle" id="taxaConclusao">üìä 0% do total</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="metric-card">
                <div class="metric-number" id="alertasAtivos">0</div>
                <div class="metric-title">üö® Alertas Ativos</div>
                <div class="metric-subtitle" id="valorRisco">‚ö†Ô∏è R$ 0,00 em risco</div>
            </div>
        </div>
    </div>

    <!-- Cards Financeiros Detalhados -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="metric-card">
                <div class="metric-number" id="receitaRealizada">R$ 0,00</div>
                <div class="metric-title">üí≥ Receita Realizada</div>
                <div class="metric-subtitle" id="taxaPagamento">üìà 0% das faturas</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="metric-card">
                <div class="metric-number" id="valorPendente">R$ 0,00</div>
                <div class="metric-title">‚è≥ Valor a Receber</div>
                <div class="metric-subtitle" id="faturasPendentes">üìÑ 0 faturas pendentes</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="metric-card">
                <div class="metric-number" id="clientesAtivos">0</div>
                <div class="metric-title">üë• Clientes Ativos</div>
                <div class="metric-subtitle" id="veiculosAtivos">üöõ 0 ve√≠culos</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="metric-card">
                <div class="metric-number" id="receitaMediaMensal">R$ 0,00</div>
                <div class="metric-title">üìÖ Receita M√©dia Mensal</div>
                <div class="metric-subtitle">üìä √öltimos 12 meses</div>
            </div>
        </div>
    </div>

    <!-- Card de Integra√ß√£o com Sistema de Frotas -->
    <div class="section-card mb-4">
        <div style="padding: 25px;">
            <h3 style="text-align: center; margin-bottom: 25px; color: #4a5568;">
                <i class="fas fa-truck"></i> Integra√ß√£o Sistema de Frotas
            </h3>

            <div class="row">
                {% if integration_available %}
                    <div class="col-md-6">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-check-circle"></i> Sistema Conectado
                                </h5>
                            </div>
                            <div class="card-body">
                                {% if is_jwt_authenticated %}
                                    <div class="alert alert-success mb-3">
                                        <i class="fas fa-user-check"></i>
                                        <strong>Autenticado:</strong> {{ frotas_user_info.nome_completo or frotas_user_info.username }}
                                    </div>
                                {% endif %}

                                <div class="d-grid gap-2">
                                    <a href="{{ frotas_dashboard_link }}" target="_blank" class="btn btn-primary">
                                        <i class="fas fa-external-link-alt"></i> Abrir Dashboard de Frotas
                                    </a>
                                    <a href="{{ frotas_system_url }}/checklists" target="_blank" class="btn btn-outline-primary">
                                        <i class="fas fa-clipboard-check"></i> Checklists Veiculares
                                    </a>
                                    <a href="{{ frotas_system_url }}/veiculos" target="_blank" class="btn btn-outline-primary">
                                        <i class="fas fa-truck"></i> Gest√£o de Ve√≠culos
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-sync-alt"></i> Sincroniza√ß√£o de Dados
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <h4 class="text-primary" id="frotasVeiculosCount">-</h4>
                                        <small class="text-muted">Ve√≠culos</small>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="text-primary" id="frotasMotoristasCount">-</h4>
                                        <small class="text-muted">Motoristas</small>
                                    </div>
                                </div>
                                <hr>
                                <div class="d-grid">
                                    <button class="btn btn-outline-info" onclick="sincronizarDados()">
                                        <i class="fas fa-sync"></i> Sincronizar Agora
                                    </button>
                                </div>
                                <small class="text-muted mt-2 d-block">
                                    <i class="fas fa-clock"></i> √öltima sincroniza√ß√£o: <span id="ultimaSincronizacao">Nunca</span>
                                </small>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="col-12">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i class="fas fa-exclamation-triangle"></i> Sistema Indispon√≠vel
                                </h5>
                            </div>
                            <div class="card-body text-center">
                                <p class="text-muted mb-3">
                                    O Sistema de Gest√£o de Frotas n√£o est√° dispon√≠vel no momento.
                                </p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Status da Conex√£o:</h6>
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times"></i> Desconectado
                                        </span>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>√öltima Tentativa:</h6>
                                        <small class="text-muted" id="ultimaTentativaConexao">-</small>
                                    </div>
                                </div>
                                <hr>
                                <button class="btn btn-warning" onclick="verificarConexaoFrotas()">
                                    <i class="fas fa-redo"></i> Tentar Reconectar
                                </button>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sistema de Alertas Inteligentes -->
    <div class="section-card mb-4">
        <div style="padding: 25px;">
            <h3 style="text-align: center; margin-bottom: 25px; color: #4a5568;">
                <i class="fas fa-exclamation-triangle"></i> Sistema de Alertas
            </h3>
            <div class="row">
                <div class="col-md-4 col-sm-12 mb-3">
                    <div id="alertaPrimeiroEnvio" class="alert-card alert-success">
                        <h5 style="margin-bottom: 10px;">üö® 1¬∫ Envio Pendente</h5>
                        <p style="margin-bottom: 5px;"><strong id="qtdPrimeiroEnvio">0</strong> CTEs pendentes</p>
                        <small id="valorPrimeiroEnvio">R$ 0,00 em risco</small>
                    </div>
                </div>
                <div class="col-md-4 col-sm-12 mb-3">
                    <div id="alertaEnvioFinal" class="alert-card alert-success">
                        <h5 style="margin-bottom: 10px;">üì§ Envio Final Pendente</h5>
                        <p style="margin-bottom: 5px;"><strong id="qtdEnvioFinal">0</strong> envios pendentes</p>
                        <small id="valorEnvioFinal">R$ 0,00 pendentes</small>
                    </div>
                </div>
                <div class="col-md-4 col-sm-12 mb-3">
                    <div id="alertaFaturasVencidas" class="alert-card alert-success">
                        <h5 style="margin-bottom: 10px;">üí∏ Faturas Vencidas</h5>
                        <p style="margin-bottom: 5px;"><strong id="qtdFaturasVencidas">0</strong> faturas vencidas</p>
                        <small id="valorFaturasVencidas">R$ 0,00 inadimplentes</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- An√°lise de Varia√ß√µes Temporais -->
    <div class="section-card mb-4">
        <div style="padding: 25px;">
            <h3 style="text-align: center; margin-bottom: 25px; color: #4a5568;">
                <i class="fas fa-chart-bar"></i> An√°lise de Performance
            </h3>
            <div id="variacoesContainer">
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p style="margin-top: 15px;">Carregando varia√ß√µes temporais...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°ficos de An√°lise -->
    <div class="row mb-4">
        <div class="col-lg-6 col-md-12 mb-4">
            <div class="chart-card">
                <div style="padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.1);">
                    <h5 style="margin: 0; color: #4a5568;">
                        <i class="fas fa-chart-line"></i> 
                        <span class="d-none d-md-inline">Evolu√ß√£o da </span>Receita Mensal
                    </h5>
                </div>
                <div class="chart-container">
                    <canvas id="chartEvolucaoMensal"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6 col-md-12 mb-4">
            <div class="chart-card">
                <div style="padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.1);">
                    <h5 style="margin: 0; color: #4a5568;">
                        <i class="fas fa-chart-pie"></i> 
                        <span class="d-none d-md-inline">Top 5 </span>Clientes
                    </h5>
                </div>
                <div class="chart-container">
                    <canvas id="chartTopClientes"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- A√ß√µes Principais -->
    <div class="text-center" style="margin-top: 40px;">
        <div class="d-flex flex-wrap justify-content-center gap-2">
            <button class="btn btn-modern" onclick="atualizarDashboard()">
                <i class="fas fa-sync-alt"></i> 
                <span class="d-none d-sm-inline">Atualizar </span>Dashboard
            </button>
            <button class="btn btn-modern" onclick="testarDebug()">
                <i class="fas fa-bug"></i> 
                <span class="d-none d-sm-inline">Testar </span>Debug
            </button>
            <a href="{{ url_for('ctes.listar') }}" class="btn btn-modern">
                <i class="fas fa-list"></i> 
                <span class="d-none d-sm-inline">Ver Todos os </span>CTEs
            </a>
            <a href="{{ url_for('analise_financeira.index') }}" class="btn btn-modern">
                <i class="fas fa-chart-line"></i>
                <span class="d-none d-sm-inline">An√°lise </span>Financeira
            </a>
            <a href="http://localhost:8050/manager-reports" target="_blank" class="btn btn-modern">
                <i class="fas fa-file-alt"></i>
                <span class="d-none d-sm-inline">Relat√≥rios </span>Gerenciais
            </a>
            <a href="http://localhost:8050/multas" target="_blank" class="btn btn-modern">
                <i class="fas fa-exclamation-triangle"></i>
                <span class="d-none d-sm-inline">Sistema de </span>Multas
            </a>
            <a href="http://localhost:8050/abastecimentos" target="_blank" class="btn btn-modern">
                <i class="fas fa-gas-pump"></i>
                <span class="d-none d-sm-inline">Controle de </span>Abastecimentos
            </a>
        </div>
    </div>

    <!-- Informa√ß√µes do Sistema -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="section-card">
                <div style="padding: 20px; text-align: center; background: rgba(102, 126, 234, 0.05);">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Sistema Dashboard Transpontual v3.0 | 
                        <span id="statusSistema">Sistema operacional</span> | 
                        √öltima sincroniza√ß√£o: <span id="ultimaSincronizacao">--:--</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingDashboard" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white;">
        <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Carregando...</span>
        </div>
        <h5>Carregando dashboard...</h5>
        <p>Processando dados financeiros...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Dashboard JavaScript -->
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

<!-- Script de Inicializa√ß√£o -->
<script>
$(document).ready(function() {
    console.log('üöÄ Inicializando dashboard principal...');
    
    // Definir timestamp de √∫ltima atualiza√ß√£o
    const agora = new Date();
    $('#ultimaAtualizacao').text('√öltima atualiza√ß√£o: ' + agora.toLocaleString('pt-BR'));
    $('#ultimaSincronizacao').text(agora.toLocaleTimeString('pt-BR'));
    
    // Aguardar carregamento das depend√™ncias
    setTimeout(function() {
        if (typeof inicializarDashboard === 'function') {
            console.log('‚úÖ Inicializando dashboard...');
            inicializarDashboard();
        } else {
            console.error('‚ùå Fun√ß√£o inicializarDashboard n√£o encontrada');
            // Fallback: tentar carregar script novamente
            const script = document.createElement('script');
            script.src = "{{ url_for('static', filename='js/dashboard.js') }}";
            script.onload = function() {
                if (typeof inicializarDashboard === 'function') {
                    inicializarDashboard();
                }
            };
            document.head.appendChild(script);
        }
    }, 500);
    
    // Atualizar timestamps
    setInterval(function() {
        const agora = new Date();
        $('#ultimaAtualizacao').text('√öltima atualiza√ß√£o: ' + agora.toLocaleString('pt-BR'));
        $('#ultimaSincronizacao').text(agora.toLocaleTimeString('pt-BR'));
    }, 60000); // A cada minuto
});

// Fun√ß√µes globais de a√ß√£o
function atualizarDashboard() {
    $('#loadingDashboard').show();
    
    // Simular carregamento
    setTimeout(function() {
        location.reload();
    }, 1500);
}

function testarDebug() {
    console.log('üîç Testando debug do dashboard...');
    
    // Verificar APIs dispon√≠veis
    const apis = [
        '/dashboard/api/metricas',
        '/dashboard/api/alertas',
        '/dashboard/api/variacoes',
        '/dashboard/api/graficos'
    ];
    
    apis.forEach(function(api) {
        $.get(api)
            .done(function(data) {
                console.log(`‚úÖ ${api}:`, data);
            })
            .fail(function(xhr) {
                console.log(`‚ùå ${api}:`, xhr.status, xhr.responseText);
            });
    });
    
    // Status do sistema
    $('#statusSistema').text('Debug executado - verifique console');
}

// Fun√ß√µes de apoio
function mostrarLoading(mostrar = true) {
    if (mostrar) {
        $('#loadingDashboard').show();
    } else {
        $('#loadingDashboard').hide();
    }
}

function atualizarMetrica(id, valor, subtitulo = null) {
    $(`#${id}`).text(valor);
    if (subtitulo) {
        $(`#${id}`).siblings('.metric-subtitle').text(subtitulo);
    }
}

// ===== FUN√á√ïES DE INTEGRA√á√ÉO COM SISTEMA DE FROTAS =====

function sincronizarDados() {
    console.log('üîÑ Iniciando sincroniza√ß√£o com Sistema de Frotas...');

    const button = $('button[onclick="sincronizarDados()"]');
    const originalText = button.html();

    // Feedback visual
    button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Sincronizando...');

    // Tentar buscar dados do sistema de frotas
    const frotasUrl = '{{ frotas_system_url }}';

    Promise.all([
        buscarDadosFrotas(`${frotasUrl}/api/v1/veiculos/count`),
        buscarDadosFrotas(`${frotasUrl}/api/v1/motoristas/count`)
    ])
    .then(([veiculos, motoristas]) => {
        // Atualizar contadores
        $('#frotasVeiculosCount').text(veiculos || '-');
        $('#frotasMotoristasCount').text(motoristas || '-');

        // Atualizar timestamp
        const agora = new Date();
        $('#ultimaSincronizacao').text(agora.toLocaleTimeString('pt-BR'));

        // Feedback de sucesso
        mostrarNotificacao('Sincroniza√ß√£o realizada com sucesso!', 'success');

        console.log('‚úÖ Sincroniza√ß√£o conclu√≠da:', { veiculos, motoristas });
    })
    .catch(error => {
        console.error('‚ùå Erro na sincroniza√ß√£o:', error);
        mostrarNotificacao('Erro na sincroniza√ß√£o. Tente novamente.', 'error');
    })
    .finally(() => {
        // Restaurar bot√£o
        button.prop('disabled', false).html(originalText);
    });
}

function buscarDadosFrotas(url) {
    return new Promise((resolve, reject) => {
        // Verificar se temos token JWT
        const jwtToken = getCookie('frotas_jwt') || getUrlParameter('jwt_token');

        const headers = {};
        if (jwtToken) {
            headers['Authorization'] = `Bearer ${jwtToken}`;
        }

        $.ajax({
            url: url,
            method: 'GET',
            headers: headers,
            timeout: 5000,
            success: function(data) {
                if (data && typeof data.count !== 'undefined') {
                    resolve(data.count);
                } else if (typeof data === 'number') {
                    resolve(data);
                } else {
                    resolve(0);
                }
            },
            error: function(xhr, status, error) {
                console.warn(`Erro ao buscar ${url}:`, status, error);
                resolve(null);
            }
        });
    });
}

function verificarConexaoFrotas() {
    console.log('üîç Verificando conex√£o com Sistema de Frotas...');

    const button = $('button[onclick="verificarConexaoFrotas()"]');
    const originalText = button.html();

    button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Verificando...');

    const frotasUrl = '{{ frotas_system_url }}';

    $.ajax({
        url: `${frotasUrl}/health`,
        method: 'GET',
        timeout: 3000,
        success: function(data) {
            mostrarNotificacao('Conex√£o com Sistema de Frotas restabelecida!', 'success');
            setTimeout(() => {
                location.reload(); // Recarregar para atualizar status
            }, 1500);
        },
        error: function(xhr, status, error) {
            const agora = new Date();
            $('#ultimaTentativaConexao').text(agora.toLocaleTimeString('pt-BR'));

            mostrarNotificacao('Sistema de Frotas ainda indispon√≠vel', 'warning');
            console.error('‚ùå Falha na reconex√£o:', status, error);
        },
        complete: function() {
            button.prop('disabled', false).html(originalText);
        }
    });
}

// ===== FUN√á√ïES AUXILIARES =====

function mostrarNotificacao(mensagem, tipo = 'info') {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[tipo] || 'alert-info';

    const notification = $(`
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed"
             style="top: 20px; right: 20px; z-index: 10000; min-width: 300px;">
            ${mensagem}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);

    $('body').append(notification);

    // Auto-remove ap√≥s 5 segundos
    setTimeout(() => {
        notification.alert('close');
    }, 5000);
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

function getUrlParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

// Inicializa√ß√£o autom√°tica dos dados de integra√ß√£o
$(document).ready(function() {
    // Se a integra√ß√£o estiver dispon√≠vel, carregar dados iniciais
    if ('{{ integration_available }}' === 'True') {
        setTimeout(() => {
            sincronizarDados();
        }, 2000); // Aguardar 2 segundos ap√≥s carregamento da p√°gina
    }
});
</script>
{% endblock %}