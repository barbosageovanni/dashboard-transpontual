{% extends "base.html" %}

{% block title %}Dashboard Transpontual{% endblock %}

{% block extra_css %}
<!-- CSS específico do Dashboard -->
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Principal -->
    <div class="header-card">
        <h1>Sistema de Gestão Financeira</h1>
        <small id="ultimaAtualizacao">Carregando...</small>
    </div>

    <!-- Cards de Métricas Principais -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="metric-card">
                <div class="metric-number" id="valorTotal">R$ 0,00</div>
                <div class="metric-title">💰 Receita Total</div>
                <div class="metric-subtitle" id="crescimentoMensal">📈 0% vs mês anterior</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="metric-card">
                <div class="metric-number" id="totalCtes">0</div>
                <div class="metric-title">📋 CTEs Total</div>
                <div class="metric-subtitle" id="ticketMedio">💵 Ticket médio: R$ 0,00</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="metric-card">
                <div class="metric-number" id="processosCompletos">0</div>
                <div class="metric-title">✅ Processos Completos</div>
                <div class="metric-subtitle" id="taxaConclusao">📊 0% do total</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="metric-card">
                <div class="metric-number" id="alertasAtivos">0</div>
                <div class="metric-title">🚨 Alertas Ativos</div>
                <div class="metric-subtitle" id="valorRisco">⚠️ R$ 0,00 em risco</div>
            </div>
        </div>
    </div>

    <!-- Cards Financeiros Detalhados -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="metric-card">
                <div class="metric-number" id="receitaRealizada">R$ 0,00</div>
                <div class="metric-title">💳 Receita Realizada</div>
                <div class="metric-subtitle" id="taxaPagamento">📈 0% das faturas</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="metric-card">
                <div class="metric-number" id="valorPendente">R$ 0,00</div>
                <div class="metric-title">⏳ Valor a Receber</div>
                <div class="metric-subtitle" id="faturasPendentes">📄 0 faturas pendentes</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="metric-card">
                <div class="metric-number" id="clientesAtivos">0</div>
                <div class="metric-title">👥 Clientes Ativos</div>
                <div class="metric-subtitle" id="veiculosAtivos">🚛 0 veículos</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="metric-card">
                <div class="metric-number" id="receitaMediaMensal">R$ 0,00</div>
                <div class="metric-title">📅 Receita Média Mensal</div>
                <div class="metric-subtitle">📊 Últimos 12 meses</div>
            </div>
        </div>
    </div>

    <!-- Sistema de Alertas Inteligentes -->
    <div class="section-card mb-4">
        <div style="padding: 25px;">
            <h3 style="text-align: center; margin-bottom: 25px; color: #4a5568;">
                <i class="fas fa-exclamation-triangle"></i> Sistema de Alertas
            </h3>
            <div class="row">
                <div class="col-md-4 col-sm-12 mb-3">
                    <div id="alertaPrimeiroEnvio" class="alert-card alert-success">
                        <h5 style="margin-bottom: 10px;">🚨 1º Envio Pendente</h5>
                        <p style="margin-bottom: 5px;"><strong id="qtdPrimeiroEnvio">0</strong> CTEs pendentes</p>
                        <small id="valorPrimeiroEnvio">R$ 0,00 em risco</small>
                    </div>
                </div>
                <div class="col-md-4 col-sm-12 mb-3">
                    <div id="alertaEnvioFinal" class="alert-card alert-success">
                        <h5 style="margin-bottom: 10px;">📤 Envio Final Pendente</h5>
                        <p style="margin-bottom: 5px;"><strong id="qtdEnvioFinal">0</strong> envios pendentes</p>
                        <small id="valorEnvioFinal">R$ 0,00 pendentes</small>
                    </div>
                </div>
                <div class="col-md-4 col-sm-12 mb-3">
                    <div id="alertaFaturasVencidas" class="alert-card alert-success">
                        <h5 style="margin-bottom: 10px;">💸 Faturas Vencidas</h5>
                        <p style="margin-bottom: 5px;"><strong id="qtdFaturasVencidas">0</strong> faturas vencidas</p>
                        <small id="valorFaturasVencidas">R$ 0,00 inadimplentes</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Análise de Variações Temporais -->
    <div class="section-card mb-4">
        <div style="padding: 25px;">
            <h3 style="text-align: center; margin-bottom: 25px; color: #4a5568;">
                <i class="fas fa-chart-bar"></i> Análise de Performance
            </h3>
            <div id="variacoesContainer">
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p style="margin-top: 15px;">Carregando variações temporais...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos de Análise -->
    <div class="row mb-4">
        <div class="col-lg-6 col-md-12 mb-4">
            <div class="chart-card">
                <div style="padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.1);">
                    <h5 style="margin: 0; color: #4a5568;">
                        <i class="fas fa-chart-line"></i> 
                        <span class="d-none d-md-inline">Evolução da </span>Receita Mensal
                    </h5>
                </div>
                <div class="chart-container">
                    <canvas id="chartEvolucaoMensal"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6 col-md-12 mb-4">
            <div class="chart-card">
                <div style="padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.1);">
                    <h5 style="margin: 0; color: #4a5568;">
                        <i class="fas fa-chart-pie"></i> 
                        <span class="d-none d-md-inline">Top 5 </span>Clientes
                    </h5>
                </div>
                <div class="chart-container">
                    <canvas id="chartTopClientes"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Ações Principais -->
    <div class="text-center" style="margin-top: 40px;">
        <div class="d-flex flex-wrap justify-content-center gap-2">
            <button class="btn btn-modern" onclick="atualizarDashboard()">
                <i class="fas fa-sync-alt"></i> 
                <span class="d-none d-sm-inline">Atualizar </span>Dashboard
            </button>
            <button class="btn btn-modern" onclick="testarDebug()">
                <i class="fas fa-bug"></i> 
                <span class="d-none d-sm-inline">Testar </span>Debug
            </button>
            <a href="{{ url_for('ctes.listar') }}" class="btn btn-modern">
                <i class="fas fa-list"></i> 
                <span class="d-none d-sm-inline">Ver Todos os </span>CTEs
            </a>
            <a href="{{ url_for('analise_financeira.index') }}" class="btn btn-modern">
                <i class="fas fa-chart-line"></i> 
                <span class="d-none d-sm-inline">Análise </span>Financeira
            </a>
        </div>
    </div>

    <!-- Informações do Sistema -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="section-card">
                <div style="padding: 20px; text-align: center; background: rgba(102, 126, 234, 0.05);">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Sistema Dashboard Transpontual v3.0 | 
                        <span id="statusSistema">Sistema operacional</span> | 
                        Última sincronização: <span id="ultimaSincronizacao">--:--</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingDashboard" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white;">
        <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Carregando...</span>
        </div>
        <h5>Carregando dashboard...</h5>
        <p>Processando dados financeiros...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Dashboard JavaScript -->
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

<!-- Script de Inicialização -->
<script>
$(document).ready(function() {
    console.log('🚀 Inicializando dashboard principal...');
    
    // Definir timestamp de última atualização
    const agora = new Date();
    $('#ultimaAtualizacao').text('Última atualização: ' + agora.toLocaleString('pt-BR'));
    $('#ultimaSincronizacao').text(agora.toLocaleTimeString('pt-BR'));
    
    // Aguardar carregamento das dependências
    setTimeout(function() {
        if (typeof inicializarDashboard === 'function') {
            console.log('✅ Inicializando dashboard...');
            inicializarDashboard();
        } else {
            console.error('❌ Função inicializarDashboard não encontrada');
            // Fallback: tentar carregar script novamente
            const script = document.createElement('script');
            script.src = "{{ url_for('static', filename='js/dashboard.js') }}";
            script.onload = function() {
                if (typeof inicializarDashboard === 'function') {
                    inicializarDashboard();
                }
            };
            document.head.appendChild(script);
        }
    }, 500);
    
    // Atualizar timestamps
    setInterval(function() {
        const agora = new Date();
        $('#ultimaAtualizacao').text('Última atualização: ' + agora.toLocaleString('pt-BR'));
        $('#ultimaSincronizacao').text(agora.toLocaleTimeString('pt-BR'));
    }, 60000); // A cada minuto
});

// Funções globais de ação
function atualizarDashboard() {
    $('#loadingDashboard').show();
    
    // Simular carregamento
    setTimeout(function() {
        location.reload();
    }, 1500);
}

function testarDebug() {
    console.log('🔍 Testando debug do dashboard...');
    
    // Verificar APIs disponíveis
    const apis = [
        '/api/dashboard/metricas',
        '/api/dashboard/alertas', 
        '/api/dashboard/variacoes',
        '/api/dashboard/graficos'
    ];
    
    apis.forEach(function(api) {
        $.get(api)
            .done(function(data) {
                console.log(`✅ ${api}:`, data);
            })
            .fail(function(xhr) {
                console.log(`❌ ${api}:`, xhr.status, xhr.responseText);
            });
    });
    
    // Status do sistema
    $('#statusSistema').text('Debug executado - verifique console');
}

// Funções de apoio
function mostrarLoading(mostrar = true) {
    if (mostrar) {
        $('#loadingDashboard').show();
    } else {
        $('#loadingDashboard').hide();
    }
}

function atualizarMetrica(id, valor, subtitulo = null) {
    $(`#${id}`).text(valor);
    if (subtitulo) {
        $(`#${id}`).siblings('.metric-subtitle').text(subtitulo);
    }
}
</script>
{% endblock %}