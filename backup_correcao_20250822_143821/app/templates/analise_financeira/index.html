{% extends "base.html" %}

{% block title %}An√°lise Financeira{% endblock %}

{% block extra_css %}
<style>
/* CSS OTIMIZADO PARA M√ÅXIMO CONTRASTE */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f8f9fa;
}

.nav-tabs-enhanced {
    border-bottom: 3px solid #198754;
    margin-bottom: 2rem;
    background: #ffffff;
    border-radius: 12px 12px 0 0;
    padding: 0.75rem 1rem 0 1rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.nav-tabs-enhanced .nav-link {
    border: 2px solid #dee2e6 !important;
    color: #000000 !important;  /* PRETO FORTE */
    font-weight: 800 !important;  /* NEGRITO M√ÅXIMO */
    padding: 1.25rem 2rem !important;
    margin: 0 0.5rem;
    border-radius: 10px 10px 0 0;
    background: #f8f9fa !important;
    font-size: 1rem !important;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.nav-tabs-enhanced .nav-link:hover:not(.active) {
    background: #e9ecef !important;
    color: #000000 !important;
    border-color: #198754 !important;
    transform: translateY(-3px);
}

.nav-tabs-enhanced .nav-link.active {
    background: #198754 !important;  /* VERDE ESCURO */
    color: #ffffff !important;  /* BRANCO PURO */
    border-color: #198754 !important;
    box-shadow: 0 6px 20px rgba(25, 135, 84, 0.5) !important;
    transform: translateY(-3px);
}

.metric-card {
    background: #ffffff;
    border-radius: 15px;
    padding: 1.75rem;
    text-align: center;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    border: 2px solid #e9ecef;
    height: 100%;
}

.metric-number {
    font-size: 2.5rem;
    font-weight: 800;
    color: #198754;
    margin: 0.75rem 0;
}

.chart-container {
    background: #ffffff;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    border: 2px solid #e9ecef;
}

.loading-spinner {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #198754;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.alert {
    border-radius: 12px;
    border: none;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="module-header text-center mb-4">
                <h2><i class="fas fa-chart-line"></i> An√°lise Financeira Avan√ßada</h2>
                <p class="mb-0">Dashboard completo com m√©tricas, proje√ß√µes e insights automatizados</p>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <label for="filtroPeriodo" class="form-label fw-bold">üìÖ Per√≠odo:</label>
                            <select id="filtroPeriodo" class="form-select">
                                <option value="7">√öltimos 7 dias</option>
                                <option value="15">√öltimos 15 dias</option>
                                <option value="30">√öltimos 30 dias</option>
                                <option value="90">√öltimos 90 dias</option>
                                <option value="180" selected>√öltimos 6 meses</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filtroCliente" class="form-label fw-bold">üë• Cliente:</label>
                            <select id="filtroCliente" class="form-select">
                                <option value="">Todos os clientes</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex gap-2 mt-4">
                                <button class="btn btn-success" onclick="aplicarFiltros()">
                                    <i class="fas fa-filter"></i> Aplicar Filtros
                                </button>
                                <button class="btn btn-outline-secondary" onclick="limparFiltros()">
                                    <i class="fas fa-times"></i> Limpar
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div id="statusFiltro" class="text-muted small mt-4">
                                Carregando...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Global -->
    <div id="loadingGlobal" class="text-center py-5" style="display: none;">
        <div class="loading-spinner"></div>
        <p class="mt-3">Carregando an√°lise financeira...</p>
    </div>

    <!-- Navega√ß√£o por Abas -->
    <ul class="nav nav-tabs nav-tabs-enhanced" id="analiseFinanceiraTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="geral-tab" data-bs-toggle="tab" data-bs-target="#geral" type="button">
                üìä Vis√£o Geral
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="projecoes-tab" data-bs-toggle="tab" data-bs-target="#projecoes" type="button">
                üîÆ Proje√ß√µes
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="comparativo-tab" data-bs-toggle="tab" data-bs-target="#comparativo" type="button">
                üìà Comparativo
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="veiculos-tab" data-bs-toggle="tab" data-bs-target="#veiculos" type="button">
                üöõ Ve√≠culos
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="insights-tab" data-bs-toggle="tab" data-bs-target="#insights" type="button">
                üß† Insights
            </button>
        </li>
    </ul>

    <!-- Conte√∫do das Abas -->
    <div class="tab-content" id="analiseFinanceiraContent">
        <!-- Aba 1: Vis√£o Geral -->
        <div class="tab-pane fade show active" id="geral" role="tabpanel">
            <!-- M√©tricas Principais -->
            <div class="row mb-4" id="metricas-principais">
                <div class="col-md-3">
                    <div class="metric-card">
                        <h6 class="text-muted">üí∞ Receita Total</h6>
                        <div class="metric-number" id="receitaTotal">R$ 0,00</div>
                        <small class="text-muted">Per√≠odo selecionado</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <h6 class="text-muted">üìã Total CTEs</h6>
                        <div class="metric-number" id="totalCTEs">0</div>
                        <small class="text-muted">Documentos emitidos</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <h6 class="text-muted">‚úÖ Valor Baixado</h6>
                        <div class="metric-number" id="valorBaixado">R$ 0,00</div>
                        <small class="text-muted">Pagamentos efetivados</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <h6 class="text-muted">‚è≥ Valor Pendente</h6>
                        <div class="metric-number" id="valorPendente">R$ 0,00</div>
                        <small class="text-muted">Aguardando pagamento</small>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico de Receita Mensal -->
            <div class="row">
                <div class="col-12">
                    <div class="chart-container">
                        <h5 class="text-center mb-4">üìà Evolu√ß√£o da Receita Mensal</h5>
                        <canvas id="chartReceitaMensal" height="100"></canvas>
                    </div>
                </div>
            </div>

            <!-- Top Clientes -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-users"></i> Top 10 Clientes</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="tabelaTopClientes">
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Faturamento</th>
                                            <th>CTEs</th>
                                            <th>Ticket M√©dio</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="4" class="text-center">Carregando dados...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aba 2: Proje√ß√µes -->
        <div class="tab-pane fade" id="projecoes" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-crystal-ball"></i> Proje√ß√µes para os Pr√≥ximos 3 Meses</h5>
                        </div>
                        <div class="card-body" id="containerProjecoes">
                            <div class="text-center py-4">
                                <div class="loading-spinner"></div>
                                <p class="mt-3">Calculando proje√ß√µes...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aba 3: Comparativo -->
        <div class="tab-pane fade" id="comparativo" role="tabpanel">
            <div class="row">
                <div class="col-md-4">
                    <label for="periodoComparativo" class="form-label fw-bold">Per√≠odo de Compara√ß√£o:</label>
                    <select id="periodoComparativo" class="form-select">
                        <option value="7">√öltimos 7 dias</option>
                        <option value="15">√öltimos 15 dias</option>
                        <option value="30" selected>√öltimos 30 dias</option>
                    </select>
                </div>
                <div class="col-md-8">
                    <button class="btn btn-success mt-4" onclick="carregarComparativo()">
                        <i class="fas fa-chart-bar"></i> Atualizar Comparativo
                    </button>
                </div>
            </div>
            
            <div class="row mt-4" id="containerComparativo">
                <div class="col-12">
                    <div class="text-center py-4">
                        <div class="loading-spinner"></div>
                        <p class="mt-3">Carregando an√°lise comparativa...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aba 4: Ve√≠culos -->
        <div class="tab-pane fade" id="veiculos" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-truck"></i> An√°lise de Faturamento por Ve√≠culo</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="tabelaVeiculos">
                                    <thead>
                                        <tr>
                                            <th>Placa</th>
                                            <th>Faturamento</th>
                                            <th>Viagens</th>
                                            <th>Ticket M√©dio</th>
                                            <th>Score</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="5" class="text-center">Carregando dados dos ve√≠culos...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aba 5: Insights -->
        <div class="tab-pane fade" id="insights" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-lightbulb"></i> Insights Autom√°ticos</h5>
                        </div>
                        <div class="card-body">
                            <div id="containerInsights">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle"></i> Sistema de Insights</h6>
                                    <p>Os insights ser√£o gerados automaticamente ap√≥s o carregamento dos dados.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// JavaScript SIMPLIFICADO E FUNCIONAL para An√°lise Financeira
let chartReceitaMensal = null;

$(document).ready(function() {
    console.log('üöÄ Inicializando An√°lise Financeira...');
    
    // Configurar eventos das abas
    $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
        const target = $(e.target).attr('data-bs-target');
        console.log('üìã Aba ativada:', target);
        
        // Carregar dados espec√≠ficos da aba
        if (target === '#projecoes') {
            carregarProjecoes();
        } else if (target === '#veiculos') {
            carregarAnaliseVeiculos();
        } else if (target === '#comparativo') {
            carregarComparativo();
        }
    });
    
    // Configurar eventos dos filtros
    $('#filtroPeriodo').on('change', aplicarFiltros);
    $('#filtroCliente').on('change', aplicarFiltros);
    
    // Carregar dados iniciais
    carregarListaClientes();
    aplicarFiltros();
});

function aplicarFiltros() {
    console.log('üîç Aplicando filtros...');
    mostrarLoading();
    carregarAnaliseGeral();
}

function limparFiltros() {
    $('#filtroPeriodo').val('180');
    $('#filtroCliente').val('');
    aplicarFiltros();
}

function mostrarLoading() {
    $('#loadingGlobal').show();
    $('#metricas-principais').hide();
}

function esconderLoading() {
    $('#loadingGlobal').hide();
    $('#metricas-principais').show();
}

function carregarListaClientes() {
    $.ajax({
        url: '/analise-financeira/api/clientes',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const select = $('#filtroCliente');
                select.empty().append('<option value="">Todos os clientes</option>');
                
                response.clientes.forEach(cliente => {
                    select.append(`<option value="${cliente}">${cliente}</option>`);
                });
            }
        },
        error: function() {
            console.warn('‚ö†Ô∏è Erro ao carregar lista de clientes');
        }
    });
}

function carregarAnaliseGeral() {
    const filtros = {
        filtro_dias: $('#filtroPeriodo').val(),
        filtro_cliente: $('#filtroCliente').val()
    };
    
    $.ajax({
        url: '/analise-financeira/api/analise-completa',
        method: 'GET',
        data: filtros,
        success: function(response) {
            if (response.success) {
                console.log('‚úÖ Dados carregados:', response);
                processarAnaliseGeral(response);
                esconderLoading();
            } else {
                mostrarErro('Erro: ' + response.error);
            }
        },
        error: function(xhr) {
            console.error('‚ùå Erro na requisi√ß√£o:', xhr);
            esconderLoading();
            mostrarErro('Erro ao carregar an√°lise: ' + xhr.status);
        }
    });
}

function processarAnaliseGeral(dados) {
    // Atualizar m√©tricas
    const resumo = dados.resumo;
    $('#receitaTotal').text(formatarMoeda(resumo.valor_total));
    $('#totalCTEs').text(resumo.total_ctes.toLocaleString());
    $('#valorBaixado').text(formatarMoeda(resumo.valor_baixado));
    $('#valorPendente').text(formatarMoeda(resumo.valor_pendente));
    
    // Atualizar status
    $('#statusFiltro').text(`‚úÖ ${resumo.total_ctes} CTEs analisados | ${resumo.percentual_baixado}% baixado`);
    
    // Atualizar gr√°fico
    if (dados.graficos && dados.graficos.receita_mensal) {
        atualizarGraficoReceita(dados.graficos.receita_mensal);
    }
    
    // Atualizar tabela de clientes
    if (dados.top_clientes) {
        atualizarTabelaClientes(dados.top_clientes);
    }
    
    // Atualizar tabela de ve√≠culos
    if (dados.analise_veiculos) {
        atualizarTabelaVeiculos(dados.analise_veiculos);
    }
}

function atualizarGraficoReceita(dadosGrafico) {
    const ctx = document.getElementById('chartReceitaMensal').getContext('2d');
    
    if (chartReceitaMensal) {
        chartReceitaMensal.destroy();
    }
    
    chartReceitaMensal = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dadosGrafico.labels,
            datasets: [{
                label: 'Receita Mensal',
                data: dadosGrafico.dados,
                borderColor: '#198754',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function atualizarTabelaClientes(clientes) {
    const tbody = $('#tabelaTopClientes tbody');
    tbody.empty();
    
    if (clientes.length === 0) {
        tbody.append('<tr><td colspan="4" class="text-center">Nenhum cliente encontrado</td></tr>');
        return;
    }
    
    clientes.forEach(cliente => {
        const ticketMedio = cliente.quantidade > 0 ? cliente.valor / cliente.quantidade : 0;
        
        tbody.append(`
            <tr>
                <td>${cliente.nome}</td>
                <td>${formatarMoeda(cliente.valor)}</td>
                <td>${cliente.quantidade}</td>
                <td>${formatarMoeda(ticketMedio)}</td>
            </tr>
        `);
    });
}

function atualizarTabelaVeiculos(veiculos) {
    const tbody = $('#tabelaVeiculos tbody');
    tbody.empty();
    
    if (veiculos.length === 0) {
        tbody.append('<tr><td colspan="5" class="text-center">Nenhum ve√≠culo encontrado</td></tr>');
        return;
    }
    
    veiculos.forEach(veiculo => {
        const badgeScore = veiculo.score >= 80 ? 'success' : 
                          veiculo.score >= 60 ? 'warning' : 'danger';
        
        tbody.append(`
            <tr>
                <td><strong>${veiculo.placa}</strong></td>
                <td>${formatarMoeda(veiculo.faturamento)}</td>
                <td>${veiculo.viagens}</td>
                <td>${formatarMoeda(veiculo.ticket_medio)}</td>
                <td><span class="badge bg-${badgeScore}">${veiculo.score}</span></td>
            </tr>
        `);
    });
}

function carregarProjecoes() {
    $('#containerProjecoes').html('<div class="text-center py-4"><div class="loading-spinner"></div><p class="mt-3">Calculando proje√ß√µes...</p></div>');
    
    $.ajax({
        url: '/analise-financeira/api/projecoes',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                let html = '<div class="row">';
                
                response.projecoes.forEach(projecao => {
                    const badgeClass = projecao.cenario === 'Otimista' ? 'success' : 
                                      projecao.cenario === 'Base' ? 'primary' : 'warning';
                    
                    html += `
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h6>${projecao.mes}</h6>
                                    <div class="metric-number">${formatarMoeda(projecao.valor_projetado)}</div>
                                    <span class="badge bg-${badgeClass}">${projecao.cenario}</span>
                                    <br>
                                    <small class="text-muted">${projecao.confianca}% confian√ßa</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                if (response.base_calculo) {
                    html += `
                        <div class="alert alert-info mt-3">
                            <h6><i class="fas fa-info-circle"></i> Metodologia</h6>
                            <p>Proje√ß√µes baseadas em ${response.base_calculo.meses_analisados} meses de dados hist√≥ricos. 
                            M√©dia mensal: ${formatarMoeda(response.base_calculo.media_mensal)}</p>
                        </div>
                    `;
                }
                
                $('#containerProjecoes').html(html);
            } else {
                $('#containerProjecoes').html('<div class="alert alert-danger">Erro: ' + response.error + '</div>');
            }
        },
        error: function() {
            $('#containerProjecoes').html('<div class="alert alert-danger">Erro ao carregar proje√ß√µes</div>');
        }
    });
}

function carregarComparativo() {
    const periodo = $('#periodoComparativo').val();
    $('#containerComparativo').html('<div class="text-center py-4"><div class="loading-spinner"></div><p class="mt-3">Carregando comparativo...</p></div>');
    
    $.ajax({
        url: '/analise-financeira/api/comparativo',
        method: 'GET',
        data: { periodo: periodo },
        success: function(response) {
            if (response.success) {
                const comp = response.comparativo;
                
                const html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6>üìÖ Per√≠odo Atual</h6>
                                    <small>${comp.periodo_atual.periodo}</small>
                                </div>
                                <div class="card-body text-center">
                                    <div class="metric-number">${formatarMoeda(comp.periodo_atual.valor)}</div>
                                    <small>${comp.periodo_atual.quantidade} CTEs</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6>üìä vs Per√≠odo Anterior</h6>
                                    <small>${comp.periodo_anterior.periodo}</small>
                                </div>
                                <div class="card-body text-center">
                                    <div class="metric-number">${formatarMoeda(comp.periodo_anterior.valor)}</div>
                                    <span class="badge ${comp.periodo_anterior.variacao_valor >= 0 ? 'bg-success' : 'bg-danger'}">
                                        ${comp.periodo_anterior.variacao_valor >= 0 ? '+' : ''}${comp.periodo_anterior.variacao_valor}%
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6>üìà vs Ano Anterior</h6>
                                    <small>${comp.ano_anterior.periodo}</small>
                                </div>
                                <div class="card-body text-center">
                                    <div class="metric-number">${formatarMoeda(comp.ano_anterior.valor)}</div>
                                    <span class="badge ${comp.ano_anterior.variacao_valor >= 0 ? 'bg-success' : 'bg-danger'}">
                                        ${comp.ano_anterior.variacao_valor >= 0 ? '+' : ''}${comp.ano_anterior.variacao_valor}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                $('#containerComparativo').html(html);
            } else {
                $('#containerComparativo').html('<div class="alert alert-danger">Erro: ' + response.error + '</div>');
            }
        },
        error: function() {
            $('#containerComparativo').html('<div class="alert alert-danger">Erro ao carregar comparativo</div>');
        }
    });
}

function carregarAnaliseVeiculos() {
    // Os dados j√° s√£o carregados na an√°lise geral
    console.log('üìä Dados de ve√≠culos j√° carregados na an√°lise geral');
}

function formatarMoeda(valor) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(valor || 0);
}

function mostrarErro(mensagem) {
    console.error('‚ùå', mensagem);
    $('#statusFiltro').text('‚ùå ' + mensagem);
}
</script>
{% endblock %}